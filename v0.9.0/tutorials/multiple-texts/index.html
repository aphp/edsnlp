<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href="../detecting-dates/" rel=prev><link href="../endlines/" rel=next><link rel=icon href="../../assets/logo/edsnlp.svg"><meta name=generator content="mkdocs-1.5.2, mkdocs-material-9.2.8"><title>Processing multiple texts - EDS-NLP</title><link rel=stylesheet href="../../assets/stylesheets/main.046329b4.min.css"><link rel=stylesheet href="../../assets/stylesheets/palette.85d0ee34.min.css"><link rel=preconnect href="https://fonts.gstatic.com" crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href="../../assets/_mkdocstrings.css"><link rel=stylesheet href="../../assets/stylesheets/extra.css"><link rel=stylesheet href="../../assets/termynal/termynal.css"><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href="#processing-multiple-texts" class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href="../.." title=EDS-NLP class="md-header__button md-logo" aria-label=EDS-NLP data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> EDS-NLP </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Processing multiple texts </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href="https://github.com/aphp/edsnlp" title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> aphp/edsnlp </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href="../.." title=EDS-NLP class="md-nav__button md-logo" aria-label=EDS-NLP data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> EDS-NLP </label> <div class=md-nav__source> <a href="https://github.com/aphp/edsnlp" title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> aphp/edsnlp </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href="../.." class=md-nav__link> <span class=md-ellipsis> Getting started </span> </a> </li> <li class=md-nav__item> <a href="https://aphp.github.io/edsnlp/demo" target=_blank class=md-nav__link> <span class=md-ellipsis> Demo </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__container"> <a href="../overview/" class="md-nav__link "> <span class=md-ellipsis> Tutorials </span> </a> <label class="md-nav__link " for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href="../overview/" class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href="../spacy101/" class=md-nav__link> <span class=md-ellipsis> spaCy 101 </span> </a> </li> <li class=md-nav__item> <a href="../quick-examples/" class=md-nav__link> <span class=md-ellipsis> Display single text outputs </span> </a> </li> <li class=md-nav__item> <a href="../matching-a-terminology/" class=md-nav__link> <span class=md-ellipsis> Matching a terminology </span> </a> </li> <li class=md-nav__item> <a href="../qualifying-entities/" class=md-nav__link> <span class=md-ellipsis> Qualifying entities </span> </a> </li> <li class=md-nav__item> <a href="../aggregating-results/" class=md-nav__link> <span class=md-ellipsis> Aggregating results </span> </a> </li> <li class=md-nav__item> <a href="../detecting-dates/" class=md-nav__link> <span class=md-ellipsis> Detecting dates </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Processing multiple texts </span> <span class="md-nav__icon md-icon"></span> </label> <a href="./" class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Processing multiple texts </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href="#what-about-a-for-loop" class=md-nav__link> What about a for loop? </a> </li> <li class=md-nav__item> <a href="#processing-a-pandas-dataframe" class=md-nav__link> Processing a pandas DataFrame </a> </li> <li class=md-nav__item> <a href="#by-hand" class=md-nav__link> "By hand" </a> </li> <li class=md-nav__item> <a href="#using-eds-nlps-helper-functions" class=md-nav__link> Using EDS-NLP's helper functions </a> <nav class=md-nav aria-label="Using EDS-NLP's helper functions"> <ul class=md-nav__list> <li class=md-nav__item> <a href="#single-process" class=md-nav__link> Single process </a> </li> <li class=md-nav__item> <a href="#multiple-processes" class=md-nav__link> Multiple processes </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href="#deploying-eds-nlp-on-sparkkoalas" class=md-nav__link> Deploying EDS-NLP on Spark/Koalas </a> <nav class=md-nav aria-label="Deploying EDS-NLP on Spark/Koalas"> <ul class=md-nav__list> <li class=md-nav__item> <a href="#declaring-types" class=md-nav__link> Declaring types </a> </li> <li class=md-nav__item> <a href="#deploying-the-pipeline" class=md-nav__link> Deploying the pipeline </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href="#one-function-to-rule-them-all" class=md-nav__link> One function to rule them all </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href="../endlines/" class=md-nav__link> <span class=md-ellipsis> Detecting end-of-lines </span> </a> </li> <li class=md-nav__item> <a href="../reason/" class=md-nav__link> <span class=md-ellipsis> Detecting Reason of Hospitalisation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href="../../advanced-tutorials/overview/" class=md-nav__link> <span class=md-ellipsis> Advanced tutorials </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href="../../pipelines/overview/" class=md-nav__link> <span class=md-ellipsis> Pipes </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href="../../tokenizers/" class=md-nav__link> <span class=md-ellipsis> Tokenizers </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href="../../utilities/connectors/overview/" class=md-nav__link> <span class=md-ellipsis> Connectors </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href="../../utilities/overview/" class=md-nav__link> <span class=md-ellipsis> Utilities </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href="../../reference/edsnlp/" class=md-nav__link> <span class=md-ellipsis> Code Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href="../../contributing/" class=md-nav__link> <span class=md-ellipsis> Contributing to EDS-NLP </span> </a> </li> <li class=md-nav__item> <a href="../../changelog/" class=md-nav__link> <span class=md-ellipsis> Changelog </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href="#what-about-a-for-loop" class=md-nav__link> What about a for loop? </a> </li> <li class=md-nav__item> <a href="#processing-a-pandas-dataframe" class=md-nav__link> Processing a pandas DataFrame </a> </li> <li class=md-nav__item> <a href="#by-hand" class=md-nav__link> "By hand" </a> </li> <li class=md-nav__item> <a href="#using-eds-nlps-helper-functions" class=md-nav__link> Using EDS-NLP's helper functions </a> <nav class=md-nav aria-label="Using EDS-NLP's helper functions"> <ul class=md-nav__list> <li class=md-nav__item> <a href="#single-process" class=md-nav__link> Single process </a> </li> <li class=md-nav__item> <a href="#multiple-processes" class=md-nav__link> Multiple processes </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href="#deploying-eds-nlp-on-sparkkoalas" class=md-nav__link> Deploying EDS-NLP on Spark/Koalas </a> <nav class=md-nav aria-label="Deploying EDS-NLP on Spark/Koalas"> <ul class=md-nav__list> <li class=md-nav__item> <a href="#declaring-types" class=md-nav__link> Declaring types </a> </li> <li class=md-nav__item> <a href="#deploying-the-pipeline" class=md-nav__link> Deploying the pipeline </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href="#one-function-to-rule-them-all" class=md-nav__link> One function to rule them all </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=processing-multiple-texts>Processing multiple texts</h1> <p>In the previous tutorials, we've seen how to apply a spaCy NLP pipeline to a single text. Once the pipeline is tested and ready to be applied on an entire corpus, we'll want to deploy it efficiently.</p> <p>In this tutorial, we'll cover a few best practices and some <em>caveats</em> to avoid. Then, we'll explore methods that EDS-NLP provides to use a spaCy pipeline directly on a pandas or Spark DataFrame. These can drastically increase throughput.</p> <p>Consider this simple pipeline:</p> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>spacy</span>

<span class=n>nlp</span> <span class=o>=</span> <span class=n>spacy</span><span class=o>.</span><span class=n>blank</span><span class=p>(</span><span class=s2>&quot;fr&quot;</span><span class=p>)</span>

<span class=n>nlp</span><span class=o>.</span><span class=n>add_pipe</span><span class=p>(</span><span class=s2>&quot;eds.sentences&quot;</span><span class=p>)</span>
<span class=n>nlp</span><span class=o>.</span><span class=n>add_pipe</span><span class=p>(</span><span class=s2>&quot;eds.normalizer&quot;</span><span class=p>)</span>

<span class=n>config</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span>
    <span class=n>terms</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>patient</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;patient&quot;</span><span class=p>,</span> <span class=s2>&quot;malade&quot;</span><span class=p>]),</span>
    <span class=n>attr</span><span class=o>=</span><span class=s2>&quot;NORM&quot;</span><span class=p>,</span>
<span class=p>)</span>
<span class=n>nlp</span><span class=o>.</span><span class=n>add_pipe</span><span class=p>(</span><span class=s2>&quot;eds.matcher&quot;</span><span class=p>,</span> <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span>

<span class=c1># Add qualifiers</span>
<span class=n>nlp</span><span class=o>.</span><span class=n>add_pipe</span><span class=p>(</span><span class=s2>&quot;eds.negation&quot;</span><span class=p>)</span>
<span class=n>nlp</span><span class=o>.</span><span class=n>add_pipe</span><span class=p>(</span><span class=s2>&quot;eds.hypothesis&quot;</span><span class=p>)</span>
<span class=n>nlp</span><span class=o>.</span><span class=n>add_pipe</span><span class=p>(</span><span class=s2>&quot;eds.family&quot;</span><span class=p>)</span>

<span class=c1># Add date detection</span>
<span class=n>nlp</span><span class=o>.</span><span class=n>add_pipe</span><span class=p>(</span><span class=s2>&quot;eds.dates&quot;</span><span class=p>)</span>
</code></pre></div> <p>Let's deploy it on a large number of documents.</p> <h2 id=what-about-a-for-loop>What about a <code>for</code> loop?</h2> <p>Suppose we have a corpus of text:</p> <div class=highlight><pre><span></span><code><span class=n>text</span> <span class=o>=</span> <span class=p>(</span>
    <span class=s2>&quot;Patient admis le 25 septembre 2021 pour suspicion de Covid.</span><span class=se>\n</span><span class=s2>&quot;</span>
    <span class=s2>&quot;Pas de cas de coronavirus dans ce service.</span><span class=se>\n</span><span class=s2>&quot;</span>
    <span class=s2>&quot;Le père du patient est atteint du covid.&quot;</span>
<span class=p>)</span>

<span class=n>corpus</span> <span class=o>=</span> <span class=p>[</span><span class=n>text</span><span class=p>]</span> <span class=o>*</span> <span class=mi>10000</span>  <span class=c1># (1)</span>
</code></pre></div> <ol> <li>This is admittedly ugly. But you get the idea, we have a corpus of 10 000 documents we want to process...</li> </ol> <p>You <em>could</em> just apply the pipeline document by document.</p> <div class=highlight><span class=filename>A naive approach</span><pre><span></span><code><span class=c1># ↑ Omitted code above ↑</span>

<span class=n>docs</span> <span class=o>=</span> <span class=p>[</span><span class=n>nlp</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>corpus</span><span class=p>]</span>
</code></pre></div> <p>It turns out spaCy has a powerful parallelisation engine for an efficient processing of multiple texts. So the first step for writing more efficient spaCy code is to use <code>nlp.pipe</code> when processing multiple texts:</p> <div class=highlight><pre><span></span><code><span class=gd>- docs = [nlp(text) for text in corpus]</span>
<span class=gi>+ docs = list(nlp.pipe(corpus))</span>
</code></pre></div> <p>The <code>nlp.pipe</code> method takes an iterable as input, and outputs a generator of <code>Doc</code> object. Under the hood, texts are processed in batches, which is often much more efficient.</p> <div class="admonition info"> <p class=admonition-title>Batch processing and EDS-NLP</p> <p>For now, EDS-NLP does not natively parallelise its components, so the gain from using <code>nlp.pipe</code> will not be that significant.</p> <p>Nevertheless, it's good practice to avoid using <code>for</code> loops when possible. Moreover, you will benefit from the batched tokenisation step.</p> </div> <p>The way EDS-NLP is used may depend on how many documents you are working with. Once working with tens of thousands of them, parallelising the processing can be really efficient (up to 20x faster), but will require a (tiny) bit more work. Here are shown 4 ways to analyse texts depending on your needs</p> <p>A <a href="#one-function-to-rule-them-all">wrapper</a> is available to simply switch between those use cases.</p> <h2 id=processing-a-pandas-dataframe>Processing a pandas DataFrame</h2> <p>Processing text within a pandas DataFrame is a very common use case. In many applications, you'll select a corpus of documents over a distributed cluster, load it in memory and process all texts.</p> <div class="admonition note"> <p class=admonition-title>The OMOP CDM</p> <p>In every tutorial that mentions distributing EDS-NLP over a corpus of documents, we will expect the data to be organised using a flavour of the <a href="https://ohdsi.github.io/CommonDataModel/" >OMOP Common Data Model</a>.</p> <p>The OMOP CDM defines two tables of interest to us:</p> <ul> <li>the <a href="https://ohdsi.github.io/CommonDataModel/cdm54.html#NOTE"><code>note</code> table</a> contains the clinical notes</li> <li>the <a href="https://ohdsi.github.io/CommonDataModel/cdm54.html#NOTE_NLP"><code>note_nlp</code> table</a> holds the results of a NLP pipeline applied to the <code>note</code> table.</li> </ul> </div> <p>To make sure we can follow along, we propose three recipes for getting the DataFrame: using a dummy dataset like before, loading a CSV or by loading a Spark DataFrame into memory.</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Dummy example</label><label for=__tabbed_1_2>Loading data from a CSV</label><label for=__tabbed_1_3>Loading data from a Spark DataFrame</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>

<span class=n>text</span> <span class=o>=</span> <span class=p>(</span>
    <span class=s2>&quot;Patient admis le 25 septembre 2021 pour suspicion de Covid.</span><span class=se>\n</span><span class=s2>&quot;</span>
    <span class=s2>&quot;Pas de cas de coronavirus dans ce service.</span><span class=se>\n</span><span class=s2>&quot;</span>
    <span class=s2>&quot;Le père du patient est atteint du covid.&quot;</span>
<span class=p>)</span>

<span class=n>corpus</span> <span class=o>=</span> <span class=p>[</span><span class=n>text</span><span class=p>]</span> <span class=o>*</span> <span class=mi>1000</span>

<span class=n>data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=n>note_text</span><span class=o>=</span><span class=n>corpus</span><span class=p>))</span>
<span class=n>data</span><span class=p>[</span><span class=s2>&quot;note_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</code></pre></div> </div> <div class=tabbed-block> <div class="no-check highlight"><pre><span></span><code><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>

<span class=n>data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=s2>&quot;note.csv&quot;</span><span class=p>)</span>
</code></pre></div> </div> <div class=tabbed-block> <div class="no-check highlight"><pre><span></span><code><span class=kn>from</span> <span class=nn>pyspark.sql.session</span> <span class=kn>import</span> <span class=n>SparkSession</span>

<span class=n>spark</span> <span class=o>=</span> <span class=n>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>.</span><span class=n>getOrCreate</span><span class=p>()</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=p>(</span><span class=s2>&quot;SELECT * FROM note&quot;</span><span class=p>)</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;note_id&quot;</span><span class=p>,</span> <span class=s2>&quot;note_text&quot;</span><span class=p>)</span>

<span class=n>data</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span><span class=o>.</span><span class=n>toPandas</span><span class=p>()</span>  <span class=c1># (1)</span>
</code></pre></div> <ol> <li>We limit the size of the DataFrame to make sure we do not overwhelm our machine.</li> </ol> </div> </div> </div> <p>We'll see in what follows how we can efficiently deploy our pipeline on the <code class=highlight><span class=n>data</span></code> object.</p> <h2 id=by-hand>"By hand"</h2> <p>We can deploy the pipeline using <code>nlp.pipe</code> directly, but we'll need some work to format the results in a usable way. Let's see how this might go, before using EDS-NLP's helper function to avoid the boilerplate code.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>spacy.tokens</span> <span class=kn>import</span> <span class=n>Doc</span>
<span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span>


<span class=k>def</span> <span class=nf>get_entities</span><span class=p>(</span><span class=n>doc</span><span class=p>:</span> <span class=n>Doc</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Return a list of dict representation for the entities&quot;&quot;&quot;</span>

    <span class=n>entities</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>doc</span><span class=o>.</span><span class=n>ents</span><span class=p>:</span>
        <span class=n>d</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span>
            <span class=n>start</span><span class=o>=</span><span class=n>ent</span><span class=o>.</span><span class=n>start_char</span><span class=p>,</span>
            <span class=n>end</span><span class=o>=</span><span class=n>ent</span><span class=o>.</span><span class=n>end_char</span><span class=p>,</span>
            <span class=n>label</span><span class=o>=</span><span class=n>ent</span><span class=o>.</span><span class=n>label_</span><span class=p>,</span>
            <span class=n>lexical_variant</span><span class=o>=</span><span class=n>ent</span><span class=o>.</span><span class=n>text</span><span class=p>,</span>
            <span class=n>negation</span><span class=o>=</span><span class=n>ent</span><span class=o>.</span><span class=n>_</span><span class=o>.</span><span class=n>negation</span><span class=p>,</span>
            <span class=n>hypothesis</span><span class=o>=</span><span class=n>ent</span><span class=o>.</span><span class=n>_</span><span class=o>.</span><span class=n>hypothesis</span><span class=p>,</span>
            <span class=n>family</span><span class=o>=</span><span class=n>ent</span><span class=o>.</span><span class=n>_</span><span class=o>.</span><span class=n>family</span><span class=p>,</span>
            <span class=n>key</span><span class=o>=</span><span class=s2>&quot;ents&quot;</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>entities</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=n>doc</span><span class=o>.</span><span class=n>spans</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;dates&quot;</span><span class=p>,</span> <span class=p>[]):</span>
        <span class=n>d</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span>
            <span class=n>start</span><span class=o>=</span><span class=n>date</span><span class=o>.</span><span class=n>start_char</span><span class=p>,</span>
            <span class=n>end</span><span class=o>=</span><span class=n>date</span><span class=o>.</span><span class=n>end_char</span><span class=p>,</span>
            <span class=n>label</span><span class=o>=</span><span class=n>date</span><span class=o>.</span><span class=n>_</span><span class=o>.</span><span class=n>date</span><span class=p>,</span>
            <span class=n>lexical_variant</span><span class=o>=</span><span class=n>date</span><span class=o>.</span><span class=n>text</span><span class=p>,</span>
            <span class=n>key</span><span class=o>=</span><span class=s2>&quot;dates&quot;</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>entities</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>entities</span>
</code></pre></div> <div class="no-check highlight"><pre><span></span><code><span class=c1># ↑ Omitted code above ↑</span>
<span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>

<span class=n>data</span><span class=p>[</span><span class=s2>&quot;doc&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>nlp</span><span class=o>.</span><span class=n>pipe</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>note_text</span><span class=p>))</span>  <span class=c1># (1)</span>
<span class=n>data</span><span class=p>[</span><span class=s2>&quot;entities&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>doc</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>get_entities</span><span class=p>)</span>  <span class=c1># (2)</span>

<span class=c1># &quot;Explode&quot; the dataframe</span>
<span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[[</span><span class=s2>&quot;note_id&quot;</span><span class=p>,</span> <span class=s2>&quot;entities&quot;</span><span class=p>]]</span><span class=o>.</span><span class=n>explode</span><span class=p>(</span><span class=s2>&quot;entities&quot;</span><span class=p>)</span>
<span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>

<span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

<span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[[</span><span class=s2>&quot;note_id&quot;</span><span class=p>]]</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>json_normalize</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>entities</span><span class=p>))</span>
</code></pre></div> <ol> <li>We use spaCy's efficient <code>nlp.pipe</code> method</li> <li>This part is far from optimal, since it uses apply... But the computationally heavy part is in the previous line, since <code>get_entities</code> merely <em>reads</em> pre-computed values from the document.</li> </ol> <p>The result on the first note:</p> <table> <thead> <tr> <th style="text-align: right;">note_id</th> <th style="text-align: right;">start</th> <th style="text-align: right;">end</th> <th style="text-align: left;">label</th> <th style="text-align: left;">lexical_variant</th> <th style="text-align: right;">negation</th> <th style="text-align: right;">hypothesis</th> <th style="text-align: right;">family</th> <th style="text-align: left;">key</th> </tr> </thead> <tbody> <tr> <td style="text-align: right;">0</td> <td style="text-align: right;">0</td> <td style="text-align: right;">7</td> <td style="text-align: left;">patient</td> <td style="text-align: left;">Patient</td> <td style="text-align: right;">0</td> <td style="text-align: right;">0</td> <td style="text-align: right;">0</td> <td style="text-align: left;">ents</td> </tr> <tr> <td style="text-align: right;">0</td> <td style="text-align: right;">114</td> <td style="text-align: right;">121</td> <td style="text-align: left;">patient</td> <td style="text-align: left;">patient</td> <td style="text-align: right;">0</td> <td style="text-align: right;">0</td> <td style="text-align: right;">1</td> <td style="text-align: left;">ents</td> </tr> <tr> <td style="text-align: right;">0</td> <td style="text-align: right;">17</td> <td style="text-align: right;">34</td> <td style="text-align: left;">2021-09-25</td> <td style="text-align: left;">25 septembre 2021</td> <td style="text-align: right;">nan</td> <td style="text-align: right;">nan</td> <td style="text-align: right;">nan</td> <td style="text-align: left;">dates</td> </tr> </tbody> </table> <h2 id=using-eds-nlps-helper-functions>Using EDS-NLP's helper functions</h2> <p>Let's see how we can efficiently deploy our pipeline using EDS-NLP's utility methods.</p> <p>They share the same arguments:</p> <table> <thead> <tr> <th>Argument</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>note</code></td> <td>A DataFrame, with two required columns, <code>note_id</code> and <code>note_text</code></td> <td>Required</td> </tr> <tr> <td><code>nlp</code></td> <td>The pipeline object</td> <td>Required</td> </tr> <tr> <td><code>context</code></td> <td>A list of column names to add context to the generate <code>Doc</code></td> <td><code>[]</code></td> </tr> <tr> <td><code>additional_spans</code></td> <td>Keys in <code>doc.spans</code> to include besides <code>doc.ents</code></td> <td><code>[]</code></td> </tr> <tr> <td><code>extensions</code></td> <td>Custom extensions to use</td> <td><code>[]</code></td> </tr> <tr> <td><code>results_extractor</code></td> <td>An arbitrary callback function that turns a <code>Doc</code> into a list of dictionaries</td> <td><code>None</code> (use extensions)</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Adding context</p> <p>You might want to store some context information contained in the <code>note</code> DataFrame as an extension in the generated <code>Doc</code> object.</p> <p>For instance, you may use the <a href="../../pipelines/misc/dates/" ><code>eds.dates</code> pipeline</a> in coordination with the <code>note_datetime</code> field to normalise a relative date (eg <code>Le patient est venu il y a trois jours/The patient came three days ago</code>).</p> <p>In this case, you can use the <code>context</code> parameter and provide a list of column names you want to add:</p> <div class="no-check highlight"><pre><span></span><code><span class=n>note_nlp</span> <span class=o>=</span> <span class=n>single_pipe</span><span class=p>(</span>
    <span class=n>data</span><span class=p>,</span>
    <span class=n>nlp</span><span class=p>,</span>
    <span class=n>context</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;note_datetime&quot;</span><span class=p>],</span>
    <span class=n>additional_spans</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;dates&quot;</span><span class=p>],</span>
    <span class=n>extensions</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;date.day&quot;</span><span class=p>,</span> <span class=s2>&quot;date.month&quot;</span><span class=p>,</span> <span class=s2>&quot;date.year&quot;</span><span class=p>],</span>
<span class=p>)</span>
</code></pre></div> <p>In this example, the <code>note_datetime</code> field becomes available as <code>doc._.note_datetime</code>.</p> </div> <p>Depending on your pipeline, you may want to extract other extensions. To do so, simply provide those extension names (without the leading underscore) to the <code>extensions</code> argument. <strong>This should cover most use-cases</strong>.</p> <p>In case you need more fine-grained control over how you want to process the results of your pipeline, you can provide an arbitrary <code>results_extractor</code> function. Said function is expected to take a spaCy <code>Doc</code> object as input, and return a list of dictionaries that will be used to construct the <code>note_nlp</code> table. For instance, the <code>get_entities</code> function defined earlier could be distributed directly:</p> <div class="no-check highlight"><pre><span></span><code><span class=c1># ↑ Omitted code above ↑</span>
<span class=kn>from</span> <span class=nn>edsnlp.processing.simple</span> <span class=kn>import</span> <span class=n>pipe</span> <span class=k>as</span> <span class=n>single_pipe</span>
<span class=kn>from</span> <span class=nn>processing</span> <span class=kn>import</span> <span class=n>get_entities</span>

<span class=n>note_nlp</span> <span class=o>=</span> <span class=n>single_pipe</span><span class=p>(</span>
    <span class=n>data</span><span class=p>,</span>
    <span class=n>nlp</span><span class=p>,</span>
    <span class=n>results_extractor</span><span class=o>=</span><span class=n>get_entities</span><span class=p>,</span>
<span class=p>)</span>
</code></pre></div> <div class="admonition danger"> <p class=admonition-title>A few caveats on using an arbitrary function</p> <p>Should you use multiprocessing, your arbitrary function needs to be serialisable as a pickle object in order to be distributed. That implies a few limitations on the way your function can be defined.</p> <p>Namely, your <strong>function needs to be discoverable</strong> (see the <a href="https://docs.python.org/3/library/pickle.html#what-can-be-pickled-and-unpickled">pickle documentation on the subject</a>). When deploying it should be defined such a way that can be accessed by the worker processes.</p> <p>For that reason, <strong>arbitrary functions can only be distributed via Spark/Koalas if their source code is advertised to the Spark workers</strong>. To that end, you should define your custom function in a pip-installed Python package.</p> </div> <h3 id=single-process>Single process</h3> <p>EDS-NLP provides a <a class="autorefs autorefs-internal" href="../../reference/edsnlp/processing/simple/#edsnlp.processing.simple.pipe"><code>single_pipe</code></a> helper function that avoids the hassle we just went through in the previous section. Using it is trivial:</p> <div class=highlight><pre><span></span><code><span class=c1># ↑ Omitted code above ↑</span>
<span class=kn>from</span> <span class=nn>edsnlp.processing.simple</span> <span class=kn>import</span> <span class=n>pipe</span> <span class=k>as</span> <span class=n>single_pipe</span>

<span class=n>note_nlp</span> <span class=o>=</span> <span class=n>single_pipe</span><span class=p>(</span>
    <span class=n>data</span><span class=p>,</span>
    <span class=n>nlp</span><span class=p>,</span>
    <span class=n>additional_spans</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;dates&quot;</span><span class=p>],</span>
    <span class=n>extensions</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;date.day&quot;</span><span class=p>,</span> <span class=s2>&quot;date.month&quot;</span><span class=p>,</span> <span class=s2>&quot;date.year&quot;</span><span class=p>],</span>
<span class=p>)</span>
</code></pre></div> <p>In just two Python statements, we get the exact same result as before!</p> <h3 id=multiple-processes>Multiple processes</h3> <p>Depending on the size of your corpus, and if you have CPU cores to spare, you may want to distribute the computation. Again, EDS-NLP makes it extremely easy for you, through the <a class="autorefs autorefs-internal" href="../../reference/edsnlp/processing/parallel/#edsnlp.processing.parallel.pipe"><code>parallel_pipe</code></a> helper:</p> <div class=highlight><pre><span></span><code><span class=c1># ↑ Omitted code above ↑</span>
<span class=kn>from</span> <span class=nn>edsnlp.processing.parallel</span> <span class=kn>import</span> <span class=n>pipe</span> <span class=k>as</span> <span class=n>parallel_pipe</span>

<span class=n>note_nlp</span> <span class=o>=</span> <span class=n>parallel_pipe</span><span class=p>(</span>
    <span class=n>data</span><span class=p>,</span>
    <span class=n>nlp</span><span class=p>,</span>
    <span class=n>additional_spans</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;dates&quot;</span><span class=p>],</span>
    <span class=n>extensions</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;date.day&quot;</span><span class=p>,</span> <span class=s2>&quot;date.month&quot;</span><span class=p>,</span> <span class=s2>&quot;date.year&quot;</span><span class=p>],</span>
    <span class=n>n_jobs</span><span class=o>=-</span><span class=mi>2</span><span class=p>,</span>  <span class=c1># (1)</span>
<span class=p>)</span>
</code></pre></div> <ol> <li>The <code>n_jobs</code> parameter controls the number of workers that you deploy in parallel. Negative inputs means "all cores minus <code class=highlight><span class=nb>abs</span><span class=p>(</span><span class=n>n_jobs</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span></code>"</li> </ol> <div class="admonition danger"> <p class=admonition-title>Using a large number of workers and memory use</p> <p>In spaCy, even a rule-based pipeline is a memory intensive object. Be wary of using too many workers, lest you get a memory error.</p> </div> <p>Depending on your machine, you should get a significant speed boost (we got 20x acceleration on a shared cluster using 62 cores).</p> <h2 id=deploying-eds-nlp-on-sparkkoalas>Deploying EDS-NLP on Spark/Koalas</h2> <p>Should you need to deploy spaCy on a distributed DataFrame such as a <a href="https://spark.apache.org/" >Spark</a> or a <a href="https://koalas.readthedocs.io/en/latest/index.html">Koalas</a> DataFrame, EDS-NLP has you covered. The procedure for those two types of DataFrame is virtually the same. Under the hood, EDS-NLP automatically deals with the necessary conversions.</p> <p>Suppose you have a Spark DataFrame:</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:3><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><input id=__tabbed_2_3 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>Using a dummy example</label><label for=__tabbed_2_2>Loading a pre-existing table</label><label for=__tabbed_2_3>Using a Koalas DataFrame</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pyspark.sql.session</span> <span class=kn>import</span> <span class=n>SparkSession</span>
<span class=kn>from</span> <span class=nn>pyspark.sql</span> <span class=kn>import</span> <span class=n>types</span> <span class=k>as</span> <span class=n>T</span>

<span class=n>spark</span> <span class=o>=</span> <span class=n>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>.</span><span class=n>getOrCreate</span><span class=p>()</span>

<span class=n>schema</span> <span class=o>=</span> <span class=n>T</span><span class=o>.</span><span class=n>StructType</span><span class=p>(</span>
    <span class=p>[</span>
        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&quot;note_id&quot;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>IntegerType</span><span class=p>()),</span>
        <span class=n>T</span><span class=o>.</span><span class=n>StructField</span><span class=p>(</span><span class=s2>&quot;note_text&quot;</span><span class=p>,</span> <span class=n>T</span><span class=o>.</span><span class=n>StringType</span><span class=p>()),</span>
    <span class=p>]</span>
<span class=p>)</span>

<span class=n>text</span> <span class=o>=</span> <span class=p>(</span>
    <span class=s2>&quot;Patient admis le 25 septembre 2021 pour suspicion de Covid.</span><span class=se>\n</span><span class=s2>&quot;</span>
    <span class=s2>&quot;Pas de cas de coronavirus dans ce service.</span><span class=se>\n</span><span class=s2>&quot;</span>
    <span class=s2>&quot;Le père du patient est atteint du covid.&quot;</span>
<span class=p>)</span>

<span class=n>data</span> <span class=o>=</span> <span class=p>[(</span><span class=n>i</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>)]</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>schema</span><span class=o>=</span><span class=n>schema</span><span class=p>)</span>
</code></pre></div> </div> <div class=tabbed-block> <div class="no-check highlight"><pre><span></span><code><span class=kn>from</span> <span class=nn>pyspark.sql.session</span> <span class=kn>import</span> <span class=n>SparkSession</span>

<span class=n>spark</span> <span class=o>=</span> <span class=n>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>.</span><span class=n>getOrCreate</span><span class=p>()</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=p>(</span><span class=s2>&quot;SELECT * FROM note&quot;</span><span class=p>)</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;note_id&quot;</span><span class=p>,</span> <span class=s2>&quot;note_text&quot;</span><span class=p>)</span>
</code></pre></div> </div> <div class=tabbed-block> <div class="no-check highlight"><pre><span></span><code><span class=kn>from</span> <span class=nn>pyspark.sql.session</span> <span class=kn>import</span> <span class=n>SparkSession</span>
<span class=kn>import</span> <span class=nn>databricks.koalas</span>

<span class=n>spark</span> <span class=o>=</span> <span class=n>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>.</span><span class=n>getOrCreate</span><span class=p>()</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=p>(</span><span class=s2>&quot;SELECT note_id, note_text FROM note&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>to_koalas</span><span class=p>()</span>
</code></pre></div> </div> </div> </div> <h3 id=declaring-types>Declaring types</h3> <p>There is a minor twist, though: Spark (or Koalas) needs to know in advance the type of each extension you want to save. Thus, if you need additional extensions to be saved, you'll have to provide a dictionary to the <code>extensions</code> argument instead of a list of strings. This dictionary will have the name of the extension as keys and its PySpark type as value.</p> <p>Accepted types are the ones present in <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql.html#data-types" target=_blank><code>pyspark.sql.types</code></a>.</p> <p>EDS-NLP provides a helper function, <a class="autorefs autorefs-internal" href="../../reference/edsnlp/processing/distributed/#edsnlp.processing.distributed.pyspark_type_finder"><code>pyspark_type_finder</code></a>, is available to get the correct type for most Python objects. You just need to provide an example of the type you wish to collect:</p> <div class="no-check highlight"><pre><span></span><code><span class=n>int_type</span> <span class=o>=</span> <span class=n>pyspark_type_finder</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

<span class=c1># Out: IntegerType()</span>
</code></pre></div> <div class="admonition danger"> <p class=admonition-title>Be careful when providing the example</p> <p><strong>Do not blindly provide the first entity matched by your pipeline</strong>: it might be ill-suited. For instance, the <code>Span._.date</code> makes sense for a date span, but will be <code>None</code> if you use an entity...</p> </div> <h3 id=deploying-the-pipeline>Deploying the pipeline</h3> <p>Once again, using the helper is trivial:</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>Spark</label><label for=__tabbed_3_2>Koalas</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="no-check highlight"><pre><span></span><code><span class=c1># ↑ Omitted code above ↑</span>
<span class=kn>from</span> <span class=nn>edsnlp.processing.distributed</span> <span class=kn>import</span> <span class=n>pipe</span> <span class=k>as</span> <span class=n>distributed_pipe</span>

<span class=n>note_nlp</span> <span class=o>=</span> <span class=n>distributed_pipe</span><span class=p>(</span>
    <span class=n>df</span><span class=p>,</span>
    <span class=n>nlp</span><span class=p>,</span>
    <span class=n>additional_spans</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;dates&quot;</span><span class=p>],</span>
    <span class=n>extensions</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;date.year&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>,</span> <span class=s2>&quot;date.month&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>,</span> <span class=s2>&quot;date.day&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>},</span>
<span class=p>)</span>

<span class=c1># Check that the pipeline was correctly distributed:</span>
<span class=n>note_nlp</span><span class=o>.</span><span class=n>show</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</code></pre></div> </div> <div class=tabbed-block> <div class="no-check highlight"><pre><span></span><code><span class=c1># ↑ Omitted code above ↑</span>
<span class=kn>from</span> <span class=nn>edsnlp.processing.distributed</span> <span class=kn>import</span> <span class=n>pipe</span> <span class=k>as</span> <span class=n>distributed_pipe</span>

<span class=n>note_nlp</span> <span class=o>=</span> <span class=n>distributed_pipe</span><span class=p>(</span>
    <span class=n>df</span><span class=p>,</span>
    <span class=n>nlp</span><span class=p>,</span>
    <span class=n>additional_spans</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;dates&quot;</span><span class=p>],</span>
    <span class=n>extensions</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;date.year&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>,</span> <span class=s2>&quot;date.month&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>,</span> <span class=s2>&quot;date.day&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>},</span>
<span class=p>)</span>

<span class=c1># Check that the pipeline was correctly distributed:</span>
<span class=n>note_nlp</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</code></pre></div> </div> </div> </div> <p>Using Spark or Koalas, you can deploy EDS-NLP pipelines on tens of millions of documents with ease!</p> <h2 id=one-function-to-rule-them-all>One function to rule them all</h2> <p>EDS-NLP provides a wrapper to simplify deployment even further:</p> <div class="no-check highlight"><pre><span></span><code><span class=c1># ↑ Omitted code above ↑</span>
<span class=kn>from</span> <span class=nn>edsnlp.processing</span> <span class=kn>import</span> <span class=n>pipe</span>

<span class=c1>### Small pandas DataFrame</span>
<span class=n>note_nlp</span> <span class=o>=</span> <span class=n>pipe</span><span class=p>(</span>
    <span class=n>note</span><span class=o>=</span><span class=n>df</span><span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span><span class=o>.</span><span class=n>toPandas</span><span class=p>(),</span>
    <span class=n>nlp</span><span class=o>=</span><span class=n>nlp</span><span class=p>,</span>
    <span class=n>n_jobs</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
    <span class=n>additional_spans</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;dates&quot;</span><span class=p>],</span>
    <span class=n>extensions</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;date.day&quot;</span><span class=p>,</span> <span class=s2>&quot;date.month&quot;</span><span class=p>,</span> <span class=s2>&quot;date.year&quot;</span><span class=p>],</span>
<span class=p>)</span>

<span class=c1>### Larger pandas DataFrame</span>
<span class=n>note_nlp</span> <span class=o>=</span> <span class=n>pipe</span><span class=p>(</span>
    <span class=n>note</span><span class=o>=</span><span class=n>df</span><span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=mi>10000</span><span class=p>)</span><span class=o>.</span><span class=n>toPandas</span><span class=p>(),</span>
    <span class=n>nlp</span><span class=o>=</span><span class=n>nlp</span><span class=p>,</span>
    <span class=n>n_jobs</span><span class=o>=-</span><span class=mi>2</span><span class=p>,</span>
    <span class=n>additional_spans</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;dates&quot;</span><span class=p>],</span>
    <span class=n>extensions</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;date.day&quot;</span><span class=p>,</span> <span class=s2>&quot;date.month&quot;</span><span class=p>,</span> <span class=s2>&quot;date.year&quot;</span><span class=p>],</span>
<span class=p>)</span>

<span class=c1>### Huge Spark or Koalas DataFrame</span>
<span class=n>note_nlp</span> <span class=o>=</span> <span class=n>pipe</span><span class=p>(</span>
    <span class=n>note</span><span class=o>=</span><span class=n>df</span><span class=p>,</span>
    <span class=n>nlp</span><span class=o>=</span><span class=n>nlp</span><span class=p>,</span>
    <span class=n>how</span><span class=o>=</span><span class=s2>&quot;spark&quot;</span><span class=p>,</span>
    <span class=n>additional_spans</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;dates&quot;</span><span class=p>],</span>
    <span class=n>extensions</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;date.year&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>,</span> <span class=s2>&quot;date.month&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>,</span> <span class=s2>&quot;date.day&quot;</span><span class=p>:</span> <span class=n>int_type</span><span class=p>},</span>
<span class=p>)</span>
</code></pre></div> <div class=footnote><hr><ol/></div> </article> </div> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href="https://squidfunk.github.io/mkdocs-material/" target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tracking", "navigation.instant", "navigation.indexes", "navigation.prune", "navigation.top", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.dff1b7c8.min.js></script> <script src=https://cdn.jsdelivr.net/npm/vega@5></script> <script src=https://cdn.jsdelivr.net/npm/vega-lite@5></script> <script src=https://cdn.jsdelivr.net/npm/vega-embed@6></script> <script src=../../assets/termynal/termynal.js></script> </body> </html>